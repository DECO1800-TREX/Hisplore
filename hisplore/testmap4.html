<!DOCTYPE html>
<html>
  <head>
    <title>Geocoding service</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css" media="screen" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body{
        padding-top:50px;
      }
      #map {
        height: 75%;
        
      }
      #floating-panel {
        position: absolute;
        top: 20px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
      #nav{
        width: 100%;
        height: 40px;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGW7c_hlZRJX3QGsDwkrAicn40AoiIZGs&callback=initMap" async defer>
    </script>
    <script   src="https://code.jquery.com/jquery-3.1.0.min.js"   integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="   crossorigin="anonymous"></script>
    <script src="js/jquery.timelinr-0.9.6.js"></script>
  <script>
    $(function(){
      $().timelinr({
        arrowKeys: 'true'
      })
    });
  </script>

  </head>
  <body>
    

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <a class="navbar-brand" href="#" >A Logo</a>
            <button class="navbar-toggle" data-toggle="collapse" data-target="#navContent">
              
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <div class="collapse navbar-collapse" id="navContent">
            <ul class="nav navbar-nav">
              <li><a href="#">SomeThing</a></li>
              <li><a href="#">SomeThing</a></li>
              <li><a href="#">SomeThing</a></li>
              <li><a href="#">About us</a></li>
              
              
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="signin.html"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> Login</a></li>
              <li><a href="#">Register</a></li>
            </ul>
            
          </div>
        </div>
      </div>




      <div id='nav'>
      <img id="loading" src="loading.gif" width="50" height="50">
      <div id="year" style="display:none;"></div>
    </div>
    <div id="timeline">
    <ul id="dates">
      <li><a id="1900">1900</a></li>
      <li><a id="1930">1930</a></li>
      <li><a id="1944">1944</a></li>
      <li><a id="1950">1950</a></li>
      <li><a id="1971">1971</a></li>
      <li><a id="1977">1977</a></li>
      <li><a id="1989">1989</a></li>
      <li><a id="1900">1900</a></li>
      <li><a id="1930">1930</a></li>
      <li><a id="1944">1944</a></li>
      <li><a id="1950">1950</a></li>
      <li><a id="1971">1971</a></li>
      <li><a id="1977">1977</a></li>
      <li><a id="1989">1989</a></li>
      
    </ul>
    <ul id='issues'>
    </ul>
    
  </div>

      <!-- <div id="floating-panel">
        
        <input id="vn" type="button" value="Vietnam">
        <input id="aus" type="button" value="Australia">
        <input id="sing" type="button" value="Singapore">
        <input id="test" type="button" value="test">
      </div> -->
      <div id="map" class="col-sm-9"></div>
      <div class="col-sm-3">
        <div class="form-group">
          <input type="text" name="search" id="search" class="form-control">
        </div>
        
        <button class="btn btn-lg btn-primary" id="btnSearchNewspaper">Search Newspaper</button>
      </div>
    
    <script>

    	// --------------- Variable ------------------- \\
      var apiKey = "jsk1qqntnrj7qbvf";
    	

      var states = ['nsw', 'act', 'qld', 'tas', 'sa', 'nt', 'wa', 'vic'];
      var geo = {'victoria':[-37.4713077,144.7851531],'act':[-35.4734679,149.0123679],'queensland':[-20.9175738,142.7027956],
        'tasmania':[-41.4545196,145.9706648],'south australia':[-30.0002315,136.2091547],'northern territory':[-19.4914108,132.5509603],
        'western australia':[-27.842557,122.614925],'new south wales':[-31.2532183,146.921099]

      };
      var markers = [];

	    
        // --------------- Some Function ------------------- \\
      	
        // function get_lat_lng(arr){
        //   var result = [];
        //   //console.log(arr);
        //   $.each(arr,function(index,item){
            
        //     var url = "https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyBGW7c_hlZRJX3QGsDwkrAicn40AoiIZGs&address="+item.state;
        //       //console.log(url);
        //     $.getJSON(url,function(data){

        //       var obj = {}
        //       obj.lat = data.results[0].geometry.location.lat;
        //       obj.lng = data.results[0].geometry.location.lng;
        //       obj.troveUrl = item.troveUrl; 
        //               //console.log(obj);
        //       result.push(obj);
        //               //console.log(result);
        //       // console.log(data.results[0].geometry.location.lat);
        //       // console.log(data.results[0].geometry.location.lng);
        //     })
            

        //   });
          
        //   $(document).ajaxStop(function() {
        //     //console.log(result);
        //     addToMarkers(result,map);
        //   });
          
          
        //}

        function get_newspaper(searchTerm,year,max_num){
          $('#loading').show();
          var result= [];
          for (var i in states){
            var url = "http://api.trove.nla.gov.au/newspaper/titles?key="+apiKey+"&encoding=json&q="+searchTerm+"&l-year="+year+"&state="+states[i]+"&callback=?";
          //console.log(url);
            
            $.getJSON(url,function(data){
              
              news = data.response.records.newspaper;
              //console.log(news);
              $.each(news,function(index,item){
                if (item.state=="National"){
                  return; // continue
                }
                var obj = {};
                //console.log(index);
                if (index==max_num){
                  //console.log('haha');
                  return false; // break
                }
                obj.state = item.state.toLowerCase();
                obj.troveUrl = item.troveUrl;
                obj.title = item.title;
                result.push(obj);
              });
            });

          }
          $(document).ajaxStop(function() {
            console.log(result);
            addToMarkers(result,map);
          });
          
          //return result;
        }
        function addToMarkers(list,map){
          //console.log(list);
          for (var i in list){
            var ran_const = 1.5;
            var geotmp = $.extend({},geo[list[i].state]);
            var obj = {};
            //console.log(geotmp[0]);
            var tmp = Math.random();
            if (tmp>0.5){
              tmp2 = Math.random()*ran_const;
              tmp3 = Math.random()*ran_const;
              geotmp[0] += tmp2;
              geotmp[1] += tmp3;
            }
            else{
              tmp2 = Math.random()*ran_const;
              tmp3 = Math.random()*ran_const;
              geotmp[0] -= tmp2;
              geotmp[1] -= tmp3;
            }
            var myLatlng = new google.maps.LatLng(geotmp[0],geotmp[1]);
            var marker = new google.maps.Marker({
              position: myLatlng,
              map: map,
              
            });

              var contentHTML = list[i].troveUrl + "<br>" + list[i].title;
               var infowindow = new  google.maps.InfoWindow({
                 content: contentHTML
               });
               marker.addListener('click',function(){
                 infowindow.open(map,marker);
                 //map.setZoom(10);
                 map.setCenter(marker.getPosition());
               });


            marker.setMap(map);
            markers.push(marker);
          }
          $('#loading').hide();
        }
      	// function addToMarkers(list,results,map,geocoder){
      		
      	// 	for (var i in list){
      			
      	// 				map.setCenter(results[0].geometry.location);
      	// 				var marker = new google.maps.Marker({
      	// 					map: map,
      	// 					position: results[0].geometry.location
      	// 				});
      	// 				var contentHTML = 'Test popup ahihihihih';
      	// 				var infowindow = new  google.maps.InfoWindow({
      	// 					content: contentHTML
      	// 				});
      	// 				marker.addListener('click',function(){
      	// 					infowindow.open(map,marker);
      	// 					map.setZoom(15);
      	// 					map.setCenter(marker.getPosition());
      	// 				});
      	// 				marker.setMap(null);
      	// 				//marker.setMap(map);
      	// 				//console.log(result)
      	// 				result.push(marker);
      					
      	// 				//console.log('cc');
      	// 			}
      		
      	// 	}
      	// 	//console.log('hah')
      	
      	

      	// function deleteMarkers(mlist,map){
      		
      	// 	for (var i in mlist){
      	// 		console.log(i);
      	// 		//alert('haha');
      	// 		mlist[i].setMap(null);
      	// 	}
      	// }

      	// function showMarkers(mlist,map){
      	// 	for (var i in mlist){
      	// 		mlist[i].setMap(map);
      	// 	}
      	// }
      	
      	function delete_all_markers(){
          for (var i in markers){
            markers[i].setMap(null);
          }
          //empty the marker list
          markers = [];
        }

      	window.initMap = function() {
	            map = new google.maps.Map(document.getElementById('map'), {
	              zoom: 4,
	              center: {lat: -26.8241, lng: 133.7751}
	            });
	            // geocoder = new google.maps.Geocoder();
	            // addToMarkers(vnList,vnMarkers,map,geocoder);
	            // addToMarkers(auList,auMarkers,map,geocoder);
	            // addToMarkers(singList,singMarkers,map,geocoder);
	            
	             
	            
	        //     document.getElementById('vn').onclick = function(){

	      		// 	if (vn_isactive){
	      		// 		deleteMarkers(vnMarkers,map);
	      		// 		vn_isactive = false;
	      		// 	}
	      		// 	else{
	      		// 		//alert('asda');
	      		// 		showMarkers(vnMarkers,map);
	      		// 		vn_isactive = true;
	      		// 	}
      			// };
      			// document.getElementById('aus').onclick = function(){

	      		// 	if (au_isactive){
	      		// 		deleteMarkers(auMarkers,map);
	      		// 		au_isactive = false;
	      		// 	}
	      		// 	else{
	      		// 		//alert('asda');
	      		// 		showMarkers(auMarkers,map);
	      		// 		au_isactive = true;
	      		// 	}
      			// };
      			// document.getElementById('sing').onclick = function(){

	      		// 	if (sing_isactive){
	      		// 		deleteMarkers(singMarkers,map);
	      		// 		sing_isactive = false;
	      		// 	}
	      		// 	else{
	      		// 		//alert('asda');
	      		// 		showMarkers(singMarkers,map);
	      		// 		sing_isactive = true;
	      		// 	}
      			// };
	            
	    }
// ---------------Main program----------------- \\


      	$('#loading').hide();
        dates = $('#dates').find('a');
        dates.each(function(index,data){
          //console.log(data);
          $(data).click(function(){
            //change the value of the "invisible" div '#year' to the selected year
            $('#year').text($(data).attr('id'));
          })
        })
        $('#btnSearchNewspaper').click(function(){
          searchTerm = $('#search').val();
          year = $('#year').text();
          console.log(year);
          delete_all_markers();
          get_newspaper('science',year,5);
        })
        
      	
    </script>
    
  </body>
</html>