<!DOCTYPE html>
<html>
  <head>
    <title>Geocoding service</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css" media="screen" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body{
        padding-top:50px;
      }
      #map {
        height: 75%;
        
      }
      #floating-panel {
        position: absolute;
        top: 20px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
      #nav{
        width: 100%;
        height: 40px;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGW7c_hlZRJX3QGsDwkrAicn40AoiIZGs&callback=initMap" async defer>
    </script>
    <script   src="https://code.jquery.com/jquery-3.1.0.min.js"   integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="   crossorigin="anonymous"></script>
    <script src="js/jquery.timelinr-0.9.6.js"></script>
  <script>
    $(function(){
      $().timelinr({
        arrowKeys: 'true'
      })
    });
  </script>

  </head>
  <body>
    

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <a class="navbar-brand" href="#" >A Logo</a>
            <button class="navbar-toggle" data-toggle="collapse" data-target="#navContent">
              
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <div class="collapse navbar-collapse" id="navContent">
            <ul class="nav navbar-nav">
              <li><a href="#">SomeThing</a></li>
              <li><a href="#">SomeThing</a></li>
              <li><a href="#">SomeThing</a></li>
              <li><a href="#">About us</a></li>
              
              
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="signin.html"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> Login</a></li>
              <li><a href="#">Register</a></li>
            </ul>
            
          </div>
        </div>
      </div>




      <div id='nav'>
      <img id="loading" src="loading.gif" width="50" height="50">
      <div id="year" style="display:none;"></div>
    </div>
    <div id="timeline">
    <ul id="dates">
      <li><a id="1900">1900</a></li>
      <li><a id="1930">1930</a></li>
      <li><a id="1944">1944</a></li>
      <li><a id="1950">1950</a></li>
      <li><a id="1971">1971</a></li>
      <li><a id="1977">1977</a></li>
      <li><a id="1989">1989</a></li>
      <li><a id="1900">1900</a></li>
      <li><a id="1930">1930</a></li>
      <li><a id="1944">1944</a></li>
      <li><a id="1950">1950</a></li>
      <li><a id="1971">1971</a></li>
      <li><a id="1977">1977</a></li>
      <li><a id="1989">1989</a></li>
      
    </ul>
    <ul id='issues'>
    </ul>
    
  </div>

      <!-- <div id="floating-panel">
        
        <input id="vn" type="button" value="Vietnam">
        <input id="aus" type="button" value="Australia">
        <input id="sing" type="button" value="Singapore">
        <input id="test" type="button" value="test">
      </div> -->
      <div id="map" class="col-sm-9"></div>
      <div class="col-sm-3">
        <div class="form-group">
          <input type="text" name="search" id="search" class="form-control">
        </div>
        
        <button class="btn btn-lg btn-primary" id="btnSearch">Click to search!</button>
      </div>
    
    <script>

    	// --------------- Variable ------------------- \\
      var apiKey = "jsk1qqntnrj7qbvf";
    	singList = ['18 Marina Gardens Drive, Singapore 018953, Singapore','1 Cluny Road, Singapore 259569, Singapore'];
    	auList = ['5 Nash Street, Rosalie Village QLD','909 wynnum rd cannon hill','St Lucia QLD 4072','91 Queen St, Brisbane City QLD 4000'];
        vnList = ['149/16 nguyen tri phuong district 5 hcm city','Số 1, Hùng Vương, Điện Biên, Ba Đình, Hà Nội, Vietnam']; 
        vnMarkers = [];
        auMarkers = [];
        singMarkers = [];
        
        vn_isactive = false;
        au_isactive = false;
        sing_isactive = false;
	    
        // --------------- Some Function ------------------- \\
      	
        function get_lat_lng(arr){
          var result = [];
          //console.log(arr);
          $.each(arr,function(index,item){
            
            var url = "https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyBGW7c_hlZRJX3QGsDwkrAicn40AoiIZGs&address="+item.state;
              //console.log(url);
            $.getJSON(url,function(data){

              var obj = {}
              obj.lat = data.results[0].geometry.location.lat;
              obj.lng = data.results[0].geometry.location.lng;
              obj.troveUrl = item.troveUrl; 
                      //console.log(obj);
              result.push(obj);
                      //console.log(result);
              // console.log(data.results[0].geometry.location.lat);
              // console.log(data.results[0].geometry.location.lng);
            })
            

          });
          
          $(document).ajaxStop(function() {
            //console.log(result);
            addToMarkers(result,map);
          });
          
          
        }

        function get_newspaper(searchTerm,year){
          $('#loading').show();
          var add = []
          var url = "http://api.trove.nla.gov.au/newspaper/titles?key="+apiKey+"&encoding=json&q="+searchTerm+"&l-year="+year+"&callback=?";
          //console.log(url);

          $.getJSON(url,function(data){
            news = data.response.records.newspaper;
            //console.log(news);
            $.each(news,function(index,item){
              if (item.state=="National"){
                return; // continue
              }
              var obj = {};
              //console.log(index);
              if (index==150){
                //console.log('haha');
                return false; // break
              }
              obj.state = item.state;
              obj.troveUrl = item.troveUrl;
              add.push(obj);
            });
          }).done(function(){
            get_lat_lng(add);
            console.log(add);
            
            
          });
          //return result;
        }
        function addToMarkers(list,map){
          //console.log(list);
          for (var i in list){
            var obj = list[i];
            var tmp = Math.random();
            if (tmp>0.5){
              tmp2 = Math.random();
              tmp3 = Math.random();
              obj.lat += tmp2;
              obj.lng += tmp3;
            }
            else{
              tmp2 = Math.random();
              tmp3 = Math.random();
              obj.lat -= tmp2;
              obj.lng -= tmp3;
            }
            var myLatlng = new google.maps.LatLng(obj.lat,obj.lng);
            var marker = new google.maps.Marker({
              position: myLatlng,
              map: map,
              
            });

              var contentHTML = list[i].troveUrl;
               var infowindow = new  google.maps.InfoWindow({
                 content: contentHTML
               });
               marker.addListener('click',function(){
                 infowindow.open(map,marker);
                 map.setZoom(10);
                 map.setCenter(marker.getPosition());
               });


            marker.setMap(map);
          }
          $('#loading').hide();
        }
      	// function addToMarkers(list,results,map,geocoder){
      		
      	// 	for (var i in list){
      			
      	// 				map.setCenter(results[0].geometry.location);
      	// 				var marker = new google.maps.Marker({
      	// 					map: map,
      	// 					position: results[0].geometry.location
      	// 				});
      	// 				var contentHTML = 'Test popup ahihihihih';
      	// 				var infowindow = new  google.maps.InfoWindow({
      	// 					content: contentHTML
      	// 				});
      	// 				marker.addListener('click',function(){
      	// 					infowindow.open(map,marker);
      	// 					map.setZoom(15);
      	// 					map.setCenter(marker.getPosition());
      	// 				});
      	// 				marker.setMap(null);
      	// 				//marker.setMap(map);
      	// 				//console.log(result)
      	// 				result.push(marker);
      					
      	// 				//console.log('cc');
      	// 			}
      		
      	// 	}
      	// 	//console.log('hah')
      	
      	

      	function deleteMarkers(mlist,map){
      		
      		for (var i in mlist){
      			console.log(i);
      			//alert('haha');
      			mlist[i].setMap(null);
      		}
      	}

      	function showMarkers(mlist,map){
      		for (var i in mlist){
      			mlist[i].setMap(map);
      		}
      	}
      	
      	

      	window.initMap = function() {
	            map = new google.maps.Map(document.getElementById('map'), {
	              zoom: 2,
	              center: {lat: -26.8241, lng: 133.7751}
	            });
	            // geocoder = new google.maps.Geocoder();
	            // addToMarkers(vnList,vnMarkers,map,geocoder);
	            // addToMarkers(auList,auMarkers,map,geocoder);
	            // addToMarkers(singList,singMarkers,map,geocoder);
	            
	             
	            
	        //     document.getElementById('vn').onclick = function(){

	      		// 	if (vn_isactive){
	      		// 		deleteMarkers(vnMarkers,map);
	      		// 		vn_isactive = false;
	      		// 	}
	      		// 	else{
	      		// 		//alert('asda');
	      		// 		showMarkers(vnMarkers,map);
	      		// 		vn_isactive = true;
	      		// 	}
      			// };
      			// document.getElementById('aus').onclick = function(){

	      		// 	if (au_isactive){
	      		// 		deleteMarkers(auMarkers,map);
	      		// 		au_isactive = false;
	      		// 	}
	      		// 	else{
	      		// 		//alert('asda');
	      		// 		showMarkers(auMarkers,map);
	      		// 		au_isactive = true;
	      		// 	}
      			// };
      			// document.getElementById('sing').onclick = function(){

	      		// 	if (sing_isactive){
	      		// 		deleteMarkers(singMarkers,map);
	      		// 		sing_isactive = false;
	      		// 	}
	      		// 	else{
	      		// 		//alert('asda');
	      		// 		showMarkers(singMarkers,map);
	      		// 		sing_isactive = true;
	      		// 	}
      			// };
	            
	    }
// ---------------Main program----------------- \\


      	$('#loading').hide();
        dates = $('#dates').find('a');
        dates.each(function(index,data){
          //console.log(data);
          $(data).click(function(){
            $('#year').text($(data).attr('id'));
          })
        })
        $('#btnSearch').click(function(){
          searchTerm = $('#search').val();
          year = $('#year').text();
          console.log(year);
          get_newspaper(searchTerm,year);
        })
        
      	
    </script>
    
  </body>
</html>